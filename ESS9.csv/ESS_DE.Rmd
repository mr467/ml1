---
title: "European Survey - What is the political sentiment in German speaking Countries
  Before Covid?"
author: "Milica Pajkic and Marco Rieder"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: yes
    toc_depth: '5'
  html_document:
    toc: yes
    toc_depth: 5
code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

# Getting the Data and installing libraries

```{r, include=FALSE}
if (!require("naniar")) install.packages("naniar", dependencies=TRUE)
if (!require("ggpubr")) install.packages("ggpubr", dependencies=TRUE)
if (!require("cowplot")) install.packages("cowplot", dependencies=TRUE)
if (!require("kernlab")) install.packages("kernlab", dependencies=TRUE)
if (!require("ISLR")) install.packages("ISLR", dependencies=TRUE)
library(ggpubr)
library(lubridate)
library(multcomp)
library(dplyr)
library(readr)
library(data.table)
library(tidyverse)
theme_set(theme_bw())
library(naniar)
library(neuralnet)
library(nnet)
library(caret)
library(gamlss.add)
library(ggplot2)
library(mgcv)

```

```{r data import}
library(naniar)
library(cowplot)
library(ISLR)
library(kernlab)
library(tidyverse)
theme_set(theme_bw())
library(car)
options(scipen=999)
```

```{r}
ess9 <- read_csv("ESS9.csv")
```

```{r making subsets of the whole dataset to only german speaking countries}
ess9_de <- subset(ess9, cntry == "DE", select =dweight:domain)
ess9_ch <- subset(ess9, cntry == "CH", select =dweight:domain)
ess9_at <- subset(ess9, cntry == "AT", select =dweight:domain)
```

# 1. Introduction

The European Social Survey (ESS) is a large scale survey conducted in over 38 countries within Europe. Focusing on public attitudes and values and changes within time. This paper is evaluating the ninth version of the survey (ESS9) form 2018.

## 1.1 Selection of parameters

The survey is really comprehensive and consists out of 572 variables. Some of them are related to others and only answered by a subset of participants.

## 1.2 Goal

# 2. Descriptive Statistics

First

```{r }
summary(ess9$nwspol)
sum(is.na(ess9$nwspol))
```

```{r echo=FALSE}
summary(ess9_de$gndr)
sum(is.na(ess9_de$gndr))
typeof(ess9_de$nwspol)
```


```{r}
str(ess9_de)
```

## 2.1 Cleaning of the data

```{r Your [pay/pensions/social benefits], which frequency do you know best}
#1 = weekly, 2 = monthly, 3 = annual
ess9_de$infqbst.na <- ess9_de$infqbst
ess9_de["infqbst.na"][ess9_de["infqbst.na"] >= 4] <- NA
ess9_de$infqbst.fac <- factor(ess9_de$infqbst.na)
summary(ess9_de$infqbst.fac)

##Grosspay 
ess9_de$grspnum.na <- ess9_de$grspnum
ess9_de["grspnum.na"][ess9_de["grspnum.na"] >= 666666666] <- NA
summary(ess9_de$grspnum.na)
###Multiplication
ess9_de$yearpay <- ifelse(ess9_de$infqbst %in% 1,
                          ess9_de$grspnum.na*52,
                          ifelse(ess9_de$infqbst %in% 2,
                                 ess9_de$grspnum.na*12,
                                 ess9_de$grspnum.na))
summary(ess9_de$yearpay)
```

```{r recode Variable resp. clean}
#NEWS Politics time recoded
ess9_de$nwspol.na <- ess9_de$nwspol
ess9_de["nwspol.na"][ess9_de["nwspol.na"] >= 7777] <- NA
#-----------------------------------------------------------------------------------------
#Educationlevel recoding
ess9_de$eduyrs.na <- ess9_de$eduyrs
ess9_de["eduyrs.na"][ess9_de["eduyrs.na"] >= 77] <- NA
#Added "Other" also under NA bc we cannot explain what other is
#-----------------------------------------------------------------------------------------
#recode the age variable
ess9_de$age.na <- ess9_de$agea
ess9_de["age.na"][ess9_de["age.na"] >= 140] <- NA
#-----------------------------------------------------------------------------------------
#record the gender variable
ess9_de$gender <- ess9_de$gndr
ess9_de["gender"][ess9_de["gender"] >= 9] <- NA
##factor/categorical
ess9_de$gndr.fac <- factor(ess9_de$gender)
#-----------------------------------------------------------------------------------------
#clean the satisfaction with democracy works in country
ess9_de$stfdem.na <- ess9_de$stfdem
ess9_de["stfdem.na"][ess9_de["stfdem.na"] > 10] <- NA
##factor/categorical
ess9_de$sat.dem.fac <- factor(ess9_de$stfdem.na)
summary(ess9_de$sat.dem.fac)
#-----------------------------------------------------------------------------------------
#clean Boycott certain products
ess9_de$bctprd.na <- ess9_de$bctprd
ess9_de["bctprd.na"][ess9_de["bctprd.na"] > 2] <- NA
##factor/categorical
ess9_de$boycott.fac <- factor(ess9_de$bctprd.na)
#-----------------------------------------------------------------------------------------
#clean left-right scale 0 =l / 10 = r
ess9_de$polscale.na <- ess9_de$lrscale
ess9_de["polscale.na"][ess9_de["polscale.na"] > 10] <- NA
#-----------------------------------------------------------------------------------------
#clean fair chance to participate in politics in yr country (5er scale)
ess9_de$fairchance <- ess9_de$frprtpl
ess9_de["fairchance"][ess9_de["fairchance"] > 6] <- NA
##factor/categorical
ess9_de$fairchance.fac <- factor(ess9_de$fairchance, levels=1:5, labels=c("not at all", "very little", "some", "a lot", "a great deal"))
#-----------------------------------------------------------------------------------------
#clean polinteresse (4er scale)
ess9_de$polinteress <- ess9_de$polintr
ess9_de["polinteress"][ess9_de["polinteress"] > 6] <- NA
##factor/categorical
ess9_de$interest.fac <- factor(ess9_de$polinteress, levels=1:4, 
                               labels=c("very", "quite", "hardly", "none at all"))
###order differently
ess9_de$interest.fac <- ordered(ess9_de$interest.fac, 
                                levels = c("none at all", "hardly", "quite", "very"))
#-----------------------------------------------------------------------------------------
#clean confidence in own ability to participate (5er scale)
ess9_de$ability <- ess9_de$cptppola
ess9_de["ability"][ess9_de["ability"] > 6] <- NA
##factor/categorical
ess9_de$ability.fac <- factor(ess9_de$ability, levels=1:5, labels=c("not at all", "a little", "quite", "very", "completely"))
summary(ess9_de$ability.fac)
#-----------------------------------------------------------------------------------------
#1 = yes / 2 = no / 3 = not eligble
ess9_de$vote.fac <- factor(ess9_de$vote, levels = 1:3, labels = c("Yes", "No", "Not eligible"))
ess9_de["vote.fac"][ess9_de["vote.fac"] >= 4] <- NA
summary(ess9_de$vote.fac)
#-----------------------------------------------------------------------------------------
#post something online in the last 12 month
ess9_de$postonline <- factor(ess9_de$pstplonl)
ess9_de["postonline"][ess9_de["postonline"] > 5] <- NA
ess9_de$postonline<-ifelse(ess9_de$postonline==1,1,0)
summary(ess9_de$postonline)
summary(as.factor(ess9_de$postonline))
summary(as.factor(ess9_de$pstplonl))
#-----------------------------------------------------------------------------------------
##Political system allows people to have a say in what government does 1 = no
ess9_de$gov.allows <- ess9_de$psppsgva
ess9_de["gov.allows"][ess9_de["gov.allows"] > 5] <- NA
ess9_de$gov.allows <- factor(ess9_de$gov.allows)
summary(ess9_de$gov.allows)
#-----------------------------------------------------------------------------------------
#Trust in country's parliament 0 = no trust
ess9_de$trustparl <- ess9_de$trstprl
ess9_de["trustparl"][ess9_de["trustparl"] > 10] <- NA
summary(as.factor(ess9_de$trustparl))
```

# 3. Models

## 3.1 Linear Model

Question: What is an influence on the

```{r all variables that i want to include}
#DV
summary(ess9_de$nwspol.na)
#predictorvariables
summary(ess9_de$eduyrs.na)
summary(ess9_de$gndr.fac)
summary(ess9_de$age.na)
summary(ess9_de$stfdem.na)
summary(ess9_de$sat.dem.fac)
summary(ess9_de$ability)
summary(ess9_de$ability.fac)
summary(ess9_de$interest.fac)
summary(as.factor(ess9_de$polinteress))
```

```{r create a DV where no outlier}
ess9_de$nwspol.outlier <- ess9_de$nwspol.na
ess9_de["nwspol.outlier"][ess9_de["nwspol.outlier"] >= 400] <- NA
```

```{r create a subset of data with only the variables mentioned above}
ess9_linear <- ess9_de[, c("nwspol.na", "age.na", "gndr.fac", "eduyrs.na", 
                           "stfdem.na", "ability", "ability.fac", "polinteress", "interest.fac", "sat.dem.fac")]
ess9_linear <- ess9_linear[complete.cases(ess9_linear),]
```

### Graphical analysis

```{r boxplots for the categorial variables w/ outliers and without outliers}
par(mfrow=c(2,3))
boxplot(nwspol.na ~ gndr.fac, data = ess9_linear)
boxplot(nwspol.na ~ ability.fac, data = ess9_linear)
boxplot(nwspol.na ~ interest.fac, data = ess9_linear)

boxplot(nwspol.na ~ gndr.fac, data = ess9_linear, outline = FALSE)
boxplot(nwspol.na ~ ability.fac, data = ess9_linear, outline = FALSE)
boxplot(nwspol.na ~ interest.fac, data = ess9_linear, outline = FALSE)
```

```{r}
plot.lin1 <- ggplot(ess9_linear, aes(age.na, nwspol.na)) + 
  ylim(0, 500)+
  geom_point()+
  ggtitle("Plot of daily News Consumption \n by age") +
  xlab("Age") + ylab("News Consumption in Minutes")

plot.lin1a <- ggplot(ess9_linear, aes(age.na, nwspol.na)) + 
  ylim(0, 200)+
  geom_point()+
  ggtitle("Plot of daily News Consumption \n by age without outlier") +
  xlab("Age") + ylab("News Consumption in Minutes")

plot_grid(plot.lin1, plot.lin1a, 
          ncol = 2, nrow = 1)
```

```{r}
gg_age.1 <- ggplot(data = ess9_linear,
       mapping = aes(y = nwspol.na,
                     x = age.na))+
  geom_point()+ggtitle("Plot of daily News Consumption \nby age without outlier") +
  xlab("Age") + ylab("News Consumption in Minutes")
  
##
gg_age.1 +
  geom_smooth()+
  ylim(0,150)
```

```{r}
gg_edu.1 <- ggplot(data = ess9_linear,
       mapping = aes(y = nwspol.na,
                     x = eduyrs.na))+
  geom_point()+ggtitle("Plot of daily News Consumption \nby age without outlier") +
  xlab("Education in Years") + ylab("News Consumption in Minutes")
  
##
gg_edu.1 +
  geom_smooth()+
  ylim(0,100)
```

### Fitting Model

```{r linear Regression}
lm_news.0 <- lm(nwspol.na ~ eduyrs.na, data = ess9_linear)
summary(lm_news.0)
```

```{r}
summary(lm_news.0)$coefficients
```

```{r}
lm_news.age <- lm(nwspol.na ~ age.na, data = ess9_linear)
summary(lm_news.age)
```

```{r}
par(mfrow=c(1,2))
plot(nwspol.na ~ eduyrs.na, data = ess9_linear,
     xlim = c(0,31), 
     ylim = c(0, 500))
#the ylim was chosen what makes the most sense over 600min watching news equals to 8h/daily
grid(ny = 20)
##
abline(lm_news.0,
       col = "red", lty = "dashed")
#Zoom in 
plot(nwspol.na ~ eduyrs.na, data = ess9_linear,
     xlim = c(0,31), 
     ylim = c(0, 100))
##
grid()
##
abline(lm_news.0,
       col = "red", lty = "dashed")
```

```{r}
plot(nwspol.na ~ age.na, data = ess9_linear, ylab = "News consumption in Minutes", main = "News consumption Daily", xlab = "Age",
     ylim = c(0, 500))
#the ylim was chosen what makes the most sense over 600min watching news equals to 8h/daily
grid(ny = 20)
##
abline(lm_news.age,
       col = "red", lwd=2)
```

Interpretation: we can see that the line is nearly flat and the p-value confirms this observation. The p-Value is nearly 1 and the parameter is nearly 0.

```{r outlier will be eliminated (above 400min)}
lm.news.outlier <- lm(nwspol.outlier ~ eduyrs.na, data = ess9_de, na.omit = TRUE)
summary(lm.news.outlier)
```

#### Adding additional predictors

```{r}
lm_news.1 <- lm(nwspol.na ~ age.na + eduyrs.na, data = ess9_linear)
summary(lm_news.1)
```

```{r}
coef(lm_news.1)
```

```{r}
summary(lm_news.1)$coefficients
```

```{r}
confint(lm_news.1)
```

We can see that the predictor age has a low p-value and it is significant.

```{r}
lm_news.2 <- lm(nwspol.na ~ eduyrs.na + age.na + gndr.fac + stfdem.na + ability.fac + interest.fac, data = ess9_linear)
summary(lm_news.2)
```

```{r}
summary(lm_news.2)$coefficients
```

```{r}
confint(lm_news.2)
```

```{r}
cis.lm_news.2 <- confint(lm_news.2)
##
## 2) plot estimates
par(mar = c(4,9,2,2))
plot(y = 1:12,
     x = rev(coef(lm_news.2)),
     xlim = c(-20, 80),
     main = "Conifidence Intervall of predictors",
     xlab = "Estimated coefficients",
     ylab = "",
     axes = FALSE)
box()
axis(side = 2, at = 1:12,
     labels = rev(names(coef(lm_news.2))), 
     las = 2)
axis(side = 1)

segments(x0 = rev(cis.lm_news.2[, "2.5 %"]),
         x1 = rev(cis.lm_news.2[, "97.5 %"]),
         y0 = 1:12,
         y1 = 1:12)
abline(v = 0, lty = "dashed")
```

#### Interaction: Age \* Interest

```{r}
lm_news.3 <- lm(nwspol.na ~ eduyrs.na + age.na * interest.fac + gndr.fac + stfdem.na + ability.fac, data = ess9_linear)
summary(lm_news.3)
```

```{r}
coef(lm_news.3)
```

```{r}
summary(lm_news.3)$coefficients
```

```{r}
confint(lm_news.3)
```

```{r}
cis.lm_news.3 <- confint(lm_news.3)
##
## 2) plot estimates
par(mar = c(4,10,2,2))
plot(y = 1:15,
     x = rev(coef(lm_news.3)),
     xlim = c(-20, 80),
     xlab = "Estimated coefficients",
     ylab = "",
     axes = FALSE)
box()
axis(side = 2, at = 1:15,
     labels = rev(names(coef(lm_news.3))), 
     las = 2)
axis(side = 1)

segments(x0 = rev(cis.lm_news.3[, "2.5 %"]),
         x1 = rev(cis.lm_news.3[, "97.5 %"]),
         y0 = 1:15,
         y1 = 1:15)
abline(v = 0, lty = "dashed")
```

The interaction is not significant

### Testing several Variables

```{r}
formula(lm_news.1)
formula(lm_news.2)
formula(lm_news.3)
```

```{r}
formula(lm_news.2)
drop1(lm_news.2, test = "F")
```

### Fitted Values and Residuals

#### Fitted Values

```{r fitted values}
fit_lm_news.0 <- fitted(lm_news.0)
str(fit_lm_news.0)
head(fit_lm_news.0)
x.fit.0 <- unique(fit_lm_news.0)
```

```{r fitted values plot lm1}
par(mfrow=c(1,2))
plot(nwspol.na ~ eduyrs.na, data = ess9_linear, 
     main = "Minutes spent on Political News", 
     col = "darkgrey",
     ylim = c(0, 500))
points(fit_lm_news.0 ~ eduyrs.na, 
       col = "purple", 
       pch = 19, 
       data = ess9_linear)
abline(lm_news.0, col = "black")

plot(nwspol.na ~ eduyrs.na, data = ess9_linear, 
     main = "Minutes spent on Political News", 
     col = "darkgrey",
     ylim = c(0, 80))
points(fit_lm_news.0 ~ eduyrs.na, 
       col = "purple", 
       pch = 19, 
       data = ess9_linear)
abline(lm_news.0, col = "black")
```

There are 67 unique values, therefore, the other observations are overlapping. Here we zoomed in to see the negative relationship between news consumption and education years.

#### Residuals

```{r}
resid.news.0 <- resid(lm_news.0)
##
length(resid.news.0 )
head(resid.news.0 )
```

```{r}
set.seed(20) ## for reproducibility 
id <- sample(x = 1:2296, size = 20) 
resid.news.0[id]
```

```{r}
fit_lm_news.0[id]
```

```{r}
plot(nwspol.na ~ eduyrs.na, data = ess9_linear,
     main = "Minutes spent on Political News",
     col = "lightgray")
##
abline(lm_news.0)
##
points(nwspol.na ~ eduyrs.na, data = ess9_linear[id, ], col = "red")
##
#segments(x0 = ess9_linear[id, "eduyrs.na"], x1 = ess9_linear[id, "eduyrs.na"],
 #        y0 = fit_lm_news.0[id], 
  #       y1 = ess9_linear[id, "nwspol.na"],  col = "blue")
```

### Predicted values

```{r}
new.data.news <- data.frame(eduyrs.na = c(18, 7, 28))
pred.new.news <- predict(object = lm_news.0, newdata = new.data.news)

plot(nwspol.na ~ eduyrs.na, data = ess9_linear,
     main = "Minutes spent on Political News",
     col = "lightgray",
      ylim=c(0, 200))
abline(lm_news.0)
points(x = new.data.news$eduyrs.na,
       y = pred.new.news,
       col = "purple",
       pch = 19, cex = 1.5)
```

```{r}
pred.new.news.ci <- predict(object = lm_news.0,
                            interval = "prediction",
        newdata = new.data.news)
pred.new.news.ci
```

```{r}
plot(nwspol.na ~ eduyrs.na, data = ess9_linear,
     main = "Minutes spent on Political News",
     col = "lightgray",
      ylim=c(0, 800))
abline(lm_news.0)
##
points(x = new.data.news$eduyrs.na,
       y = pred.new.news.ci[, "fit"], 
       col = "purple",
       pch = 19, cex = 1.5)
##
segments(x0 = new.data.news$eduyrs.na, 
         x1 = new.data.news$eduyrs.na,
         y0 = pred.new.news.ci[, "lwr"],
         y1 = pred.new.news.ci[, "upr"],
         lwd = 2,
         col = "purple")
```

## 3.2 GLM Poisson

The goal of this chapter is to apply a generalized linear model of the poisson type on the ESS9 data set. The poisson model is applied to count data, in this case the information of how many minutes the participants spend per day for consuming media, such as newspaper, TV new shows or online resources. In this chapter the model is used to simulate the data, based on the provided data from the survey. First the data is cleaned and prepared for using it. A subset of the data is used, containing variables which should help to model the news consumption of a person. These parameters are used: Depended variable: 

* How much politics are you watching ("nwspol") Independent variables:

The goal of this chapter is to apply a generalized linear model of the poisson type on the ESS9 data set. 
The poisson model is applied to count data, in this case the information of how many minutes the participants spend per day for consuming media, such as newspaper, TV new shows or online resources. 
In this chapter the model is used to simulate the data, based on the provided data from the survey. 
First the data is cleaned and prepared for using it. A subset of the data is used, containing variables which should help to model the news consumption of a person. 
These parameters are used:
Depended variable: 

* How much politics are you watching ("nwspol")
Independent variables:

* Interest in politics ("polintr)
* Trust into the current parlament ("trstprl")
* Highest level of education ("eisced")
* Years of education ("eduyrs")
* Satisfaction with the general economical situation ("stfeco")
* Satisfaction with the current government ("stfgov")
* Gender ("gndr")
* Age ("agea")
* Level of person religion believe ("rlgdgr")
* Time spent online ("netusoft")
* Posibility for political participation ("psppsgva")
* Yearly gross income (combination of two factors into a new one - "yrpy")

-   Interest in politics ("polintr)
-   Trust into the current parlament ("trstprl")
-   Highest level of education ("eisced")
-   Years of education ("eduyrs")
-   Satisfaction with the general economical situation ("stfeco")
-   Satisfaction with the current government ("stfgov")
-   Gender ("gndr")
-   Age ("agea")
-   Level of person religion believe ("rlgdgr")
-   Time spent online ("netusoft")
-   Posibility for political participation ("psppsgva")
-   Yearly gross income (combination of two factors into a new one - "yrpy")

### 3.2.1 Data preparation

The data have to be prepared and transformed. For poisson count data are needed for the predictive variable. The time in minutes is modeled therefore.

```{r data preparation for models, include=TRUE}
# Setting NA values correct for the used parameters replace with NA replace function from naniar package. As each variable has a different NA setting, it is specified for each variable.

ess9_prep <- ess9 %>%
  replace_with_na(replace = list(nwspol =
                                   c(6666, 7777, 8888, 9999),
                                 polintr = c(7,8,9),
                                 trstprl = c(77,88,99),
                                 eisced = c(77,88,99),
                                 eduyrs = c(77, 88, 99),
                                 stfeco = c(77, 88, 99),
                                 stfgov = c(77, 88, 99),
                                 stfdem = c(77, 88, 99),
                                 gndr = 9,
                                 agea = 999,
                                 rlgdgr = c(77, 88, 99),
                                 netustm = c(6666, 7777, 8888, 9999),
                                 netusoft = c(7,8,9),
                                 psppsgva = c(7,8,9),
                                 grspnum = c(666666666,777777777,888888888,999999999),
                                 infqbst = c(6,7,8,9)
                                 
                                 ))

#testing if change has worked and how many NA we have - for four examples

sum(is.na(ess9_prep$nwspol))
sum(is.na(ess9_prep$eduyrs))
sum(is.na(ess9_prep$stfgov))
sum(is.na(ess9_prep$netusoft))

# The variable "grspnum" is depended on the variable "infqbst." As "infqbst" sets the period of the payment and "grpsnum" is the payment amount for the defined period. To standardize it on a yearly gross payment it needs a nested ifelse statement. If "infqbst" is one, we multiple it by 52 weeks of the year, if it is a two we multiple it by 12, and if it something else we keep it as it is (3 is already yearly payment, and values above will be filterd in the next step. 

ess9_prep$yrpy <- ifelse(ess9_prep$infqbst %in% 1,
                                ess9_prep$grspnum*52,  
                            ifelse(ess9_prep$infqbst %in% 2,
                                ess9_prep$grspnum*12, 
                                ess9_prep$grspnum))
```

Subset of data for this task, as 14 parameters in total. The rows with NA are dropped, as the data set is large enough for droping theses values.

```{r data subset and NA, include=TRUE}
# defining subset for study and models. These factors will be used in the Poisson and Neural Network models below. 
ess9_subset <- c("nwspol", "polintr", "trstprl", "eisced", "eduyrs","stfeco", "stfgov", "stfdem", "gndr", "agea","rlgdgr","netusoft", "psppsgva", "yrpy")

#subsetting the dataset with the defined parameters
ess9_prep <- ess9_prep[ess9_subset]

# drop NA for the columns used for the poisson model
ess9_prep <- ess9_prep %>% drop_na((ess9_subset))

#keep data for AMM part as numeric values - saved for later
ess9_prep_num <- ess9_prep
```


```{r data factorization, include=TRUE}

# set of parameters which are categorical variables
factors <- c("polintr","trstprl", "eisced", "stfeco", "stfgov", "stfdem", "gndr", "rlgdgr", "psppsgva", "netusoft")

# applying factorization of variables
ess9_prep[factors] <- lapply(ess9_prep[factors], as.factor)
#show data after preparation
str(ess9_prep)

```


The plot shows the media consumption for male and female. Males have a higher mean and the variance of the first and thrid quantile are larger. 


The plot shows the media consumption for male and female. Males have a higher mean and the variance of the first and third quantile are larger.


```{r plotting of media consumaption}
# Use cleaned and factorized data for the Poisson model
ess9_poisson <- ess9_prep

ggplot(data = ess9_poisson, mapping = aes(y = nwspol,x = gndr)) +
  geom_boxplot() +
  ggtitle("Media consumption in minutes compared to Gender (Zoomed In)")+
  ylab("media consumption in minutes") +
  xlab("Gender") +
  coord_cartesian(ylim = quantile(ess9_poisson$nwspol, c(0.1, 0.9))) # large outliers are cropt out to indicate variance of male and female

```

### 3.2.2 Fitting the poisson model

Using the parameter specified above to model the consumption.

```{r Poisson model fitting}
# fitting the model
glmP_news <- glm(nwspol ~ polintr + eisced + trstprl+ eduyrs + netusoft + stfeco + stfgov +
                   stfdem + gndr + agea + rlgdgr +yrpy,
                 family = "poisson", ## we specify the distribution!
                 data = ess9_poisson)

summary(glmP_news)

coef(glmP_news)

exp(coef(glmP_news)["(Intercept)"])

```

### 3.2.3 Simulation

Now we simulate with our model the average media consumption for Females and Males.

```{r poisson}

set.seed(2) # for reproducibility
#simulate the data from glm poisson
sim.data.ess9.Poisson <- simulate(glmP_news)
##

NROW(sim.data.ess9.Poisson)
head(sim.data.ess9.Poisson)

#plot data as bar plot, with gender as factor to get two groups to compare, without factoring only one plot would show.
ggplot(mapping = aes(y = sim.data.ess9.Poisson$sim_1,
                     x = ess9_poisson$gndr)) +
  geom_boxplot() +
  geom_hline(yintercept = 0) +
  ylab("simulated media consumption \n(assuming Poisson dist)") +
  xlab("Gender") +
  coord_cartesian(ylim = quantile(ess9_poisson$nwspol, c(0.1, 0.9))) # large outliers are removed to indicate variance of male and female

```


The simulated data look similar as the real data based of the survey. The variance is smaller for the simulated one. The higher mean for males are in both plots visible.

The simulated data look similar as the real data based of the survey. The variance is smaller for the simulated one. The higher mean and the higher variance for the male group is indicated in the real data as well as in the simulated data. 

### 3.2.4 GLM Quasi-Poisson

```{r quasipoisson}
glmQ_news <- glm(nwspol ~ polintr + eisced + trstprl+ eduyrs + netusoft + stfeco + stfgov +
                   stfdem + gndr + agea + rlgdgr +yrpy,
                 family = "quasipoisson", ## we specify the distribution!
                 data = ess9_poisson)
summary(glmQ_news)
```

```{r quasipoisson - Anova for Gender}

# Checking if Gender plays a role in the quasipoisson model. With the ANOVA function.
glmQ_news_noGender <- update(glmQ_news, . ~ . - gndr)
anova(glmQ_news, glmQ_news_noGender, test = "F")
```

Yes, Gender plays a role for the quasi poisson model.

```{r quasipoisson - Anova for stfdem}

# Checking if Gender plays a role in the quasipoisson model. With the ANOVA function.
glmQ_news_noGender <- update(glmQ_news, . ~ . - stfdem)
anova(glmQ_news, glmQ_news_noGender, test = "F")
```

To compare it with the variable of "stfdem" about how satisfied the participants of the survey are about how the democracy in their country works. This variable doensn't play a role to predict the media consumption according to the quasipoisson model.

## 3.3 GLM Binomial

```{r subset of dataframe because of differen NA}
ess9_binary <- ess9_de[, c("postonline", "age.na", "interest.fac", "gov.allows", "trustparl", "polscale.na", "eduyrs.na", "ability.fac", "sat.dem.fac", "boycott.fac", "vote.fac")]
ess9_binary.na <- ess9_binary[complete.cases(ess9_binary),]
```

```{r}
str(ess9_binary.na)
```

### Graphical Analysis

```{r}
pairs(postonline ~ age.na + interest.fac + gov.allows +
trustparl + polscale.na +
ability.fac + sat.dem.fac + boycott.fac + vote.fac, data = ess9_binary.na, upper.panel = panel.smooth)
```

```{r EDA}

g1 <- ggplot(data = ess9_binary.na,
       mapping = aes(y = postonline,
                     x = age.na))+
  geom_point()+
  geom_smooth(method = "glm", 
              se = FALSE,
              method.args = list(family = "binomial")) 

g2 <- ggplot(data = ess9_binary.na,
       mapping = aes(y = postonline,
                     x = eduyrs.na))+
  geom_point()+
  geom_smooth(method = "glm", 
              se = FALSE,
              method.args = list(family = "binomial")) 

g3 <- ggplot(data = ess9_binary.na,
       mapping = aes(y = postonline,
                     x = interest.fac))+
  geom_point()+
  geom_smooth(method = "glm", 
              se = FALSE,
              method.args = list(family = "binomial")) 

g4 <- ggplot(data = ess9_binary.na,
       mapping = aes(y = postonline,
                     x = ability.fac))+
  geom_point()+
  geom_smooth(method = "glm", 
              se = FALSE,
              method.args = list(family = "binomial")) 

g5 <- ggplot(data = ess9_binary.na,
       mapping = aes(y = postonline,
                     x = boycott.fac))+
  geom_point()+
  geom_smooth(method = "glm", 
              se = FALSE,
              method.args = list(family = "binomial")) 

g6 <- ggplot(data = ess9_binary.na,
       mapping = aes(y = postonline,
                     x = vote.fac))+
  geom_point()+
  geom_smooth(method = "glm", 
              se = FALSE,
              method.args = list(family = "binomial")) 

plot_grid(g1, g2, g3, g4, g5, g6,
          ncol = 2, nrow = 3)
```

### Fitting the binary model (logistic regression

```{r glm model for binary data}
glm_pol.0 <- glm(postonline ~ age.na, data = ess9_binary.na,
                 family = "binomial")
summary(glm_pol.0)
```

```{r}
glm_pol.1 <- glm(postonline ~ age.na + eduyrs.na + interest.fac, data = ess9_binary.na,
                 family = "binomial")
summary(glm_pol.1)
```

### Estimating the performance of a binary model

```{r}
fitted(glm_pol.0) %>% round(digits = 2)
```

```{r}
fitted_glm.pol.0.disc <- ifelse(fitted(glm_pol.0) < 0.3, 
                                yes = 1, no = 0)
head(fitted_glm.pol.0.disc)
summary(as.factor(fitted_glm.pol.0.disc))
```

```{r}
d.obs.fit.glm.pol <- data.frame(obs = ess9_binary.na$postonline,                            
                                fitted = fitted_glm.pol.0.disc) 
table(d.obs.fit.glm.pol)
```

## 3.4 GAM

In this chapter a generalized additive model (GAM) is applied to the data set. First the data is visually analyzed and checked. The variables don't show a strong relation ship and the line is mostly horizontal.

```{r GAM peperation}
ess9_GAM <- ess9_prep

# Multi plots for News Consumption

pairs((nwspol) ~ . , data = ess9_GAM, pch = ".", upper.panel = panel.smooth)
#plotting news consumption and highest level of education (standardized)
ggplot(data = ess9_GAM ,mapping = aes(y = nwspol ,
                                  x = eisced)) +
  geom_boxplot()


# ploting news and age of participants
ggplot(data = ess9_GAM ,mapping = aes(y = nwspol ,
                                  x =  (agea))) +
  geom_point()+
  geom_smooth()

#plotting news and education

ggplot(data = ess9_GAM ,mapping = aes(y = nwspol ,
                                  x =  (eduyrs))) +
  geom_point()+
  geom_smooth()


ggplot(data = ess9_GAM ,mapping = aes(y = nwspol ,
                                  x =  (yrpy))) +
  geom_point()+
  geom_smooth()
```


```{r GAM}
GAM.netusoft <- gam((as.numeric(netusoft)) ~ yrpy + 
                      s(nwspol) + s(agea) + 
                      s(eduyrs, k= 1),
                data = ess9_poisson)
plot(GAM.netusoft, residuals = TRUE, cex = 2)
```
```{r}
GAM.netusoft2 <- gam((as.numeric(netusoft)) ~ yrpy + 
                      s(nwspol) + s(agea) + 
                      eduyrs,
                data = ess9_poisson)

plot(GAM.netusoft2, residuals = TRUE, cex = 2)

```

## 3.5 Neural Network

Additional to "classic" linear models and GLM options, there are neural networks for analyzing and predicting data.

## 3.5 Neural Network 

Within this chapter two types of neural network model are applied to two different questions. 

1. Predicting the values for the continuous variable 
2. Predicting the vallues for the categorical variable inidicating the 5 levels of 
### 3.5.1 continious variable


```{r data import for neural network}

ess9_ann<- ess9_prep_num

str(ess9_ann)

```

#### Prepare for Training

```{r preparation}
set.seed(123)
ess9_ann[factors] <- lapply(ess9_ann[factors], as.numeric)

indices <- createDataPartition(ess9_ann$nwspol, p = 0.8, list = FALSE)
train <- ess9_ann %>% slice(indices)
test <- ess9_ann %>% slice(-indices)
boxplot(train$nwspol, test$nwspol, ess9_ann %>% sample_frac(0.2) %>% pull(nwspol), outline = FALSE)
```


```{r scaling of data}
max <- apply(ess9_ann, 2, max)
min <- apply(ess9_ann, 2, min)
ess9_ann_scaled <- as.data.frame(scale(ess9_ann, center = min, scale = max - min))
train_scaled <- ess9_ann_scaled %>% slice(indices)
test_scaled <- ess9_ann_scaled %>% slice(-indices)
```

#### Fit the Network

```{r NN model fitting}


set.seed(42)
ess9_nnet = neuralnet(nwspol ~ polintr + eisced + trstprl+ eduyrs + netusoft + 
                        stfeco + stfgov + stfdem + gndr + agea + rlgdgr +yrpy,
                      train_scaled, hidden = 3 , linear.output = FALSE)
plot(ess9_nnet)
```

#### Predict the test set

```{r, include=FALSE}
pred <- compute(ess9_nnet, test %>% select(-nwspol))
pred$net.result
```

So what went wrong here? Obviously we also need to use the scaled data to make predictions and then scale back to real nwspol values

```{r predict, include=FALSE}
pred_scaled <- compute(ess9_nnet, test_scaled %>% select(-nwspol))
pred <- pred_scaled$net.result * (max(ess9_ann$nwspol) - min(ess9_ann$nwspol)) + min(ess9_ann$nwspol)
pred
```


```{r plot comparsion of real and predicated data}
plot(test$nwspol, pred, col='blue', pch=16, ylab = "predicted nwspol NN", xlab = "real nwspol")
abline(0,1)
```

And calculate the RMSE

```{r RMSE}
sqrt(mean((test$nwspol - pred)^2))
```

#### Redo with `caret` and Cross Validation

```{r caret applied again, include=FALSE, message=FALSE, warning=FALSE}
set.seed(42)
tuGrid <- expand.grid(.layer1=c(1:1), .layer2=c(0,2), .layer3=c(0))


trCtrl <- trainControl(
  method = 'repeatedcv', 
  number = 4, 
  repeats = 8, 
  returnResamp = 'final'
)

models <- train(
  x = ess9_ann %>% select(-nwspol),
  y = ess9_ann_scaled %>% pull(nwspol),
  method = 'neuralnet', metric = 'RMSE', 
  linear.output = FALSE,
  # be careful, does only work on x!
  preProcess = c('center', 'scale'),
  tuneGrid = tuGrid,
  trControl = trCtrl
)
```

```{r message=FALSE, warning=FALSE}
plot(test$nwspol, pred, col='blue', pch=16, ylab = "predicted rating NN", xlab = "real rating")
abline(0,1)
```

```{r}
plot(models)
```

and extract the best model

```{r}
plot(models$finalModel)
```

### 3.5.2 Categorical variable

```{r}
ess9_ann2<- ess9_prep_num

ess9_ann2$netusoft <- as.factor(ess9_ann2$netusoft)


str(ess9_ann2)
```

#### Have a quick look at the Data

```{r}
ess9_ann2 %>%
  ggplot(aes(x = yrpy, y = nwspol, color = netusoft)) +
  geom_point()
```

```{r}
ess9_ann2 %>%
  ggplot(aes(x = eduyrs, y = nwspol, color = netusoft)) +
  geom_point()
```

#### Prepare the Data for Training

```{r}
set.seed(123)
indices <- createDataPartition(ess9_ann2$netusoft, p=.85, list = F)
```

#### Why do we use the `caret` function

Look at the distribution of our different prediction classes in the train and test datasets:

```{r}
ess9_ann2 %>%
  mutate(train = row_number() %in% indices) %>%
  select(netusoft, train) %>%
  table()
```

Now compare this to the "random" approach:

```{r}
ess9_ann2 %>%
  mutate(train = runif(nrow(ess9_ann2)) < .85) %>%
  select(netusoft, train) %>%
  table()
```

So using the `createDataPartition` function makes sure that no class is over- or underrepresented relative to the total occurance in the two sets

#### Create some easy Variables to access Data

```{r}
train <- ess9_ann2 %>%
  slice(indices)
test_in <- ess9_ann2 %>%
  slice(-indices) %>%
  select(-netusoft)
test_truth <- ess9_ann2 %>%
  slice(-indices) %>%
  pull(netusoft)
```

#### Train the Neural Network

Call the `neuralnet` function creating a network with two hidden layers containing 4 and 3 neurons (probably way too complex for our problem here).

```{r}
set.seed(21)
ess9_ann_net <- neuralnet(netusoft ~ ., train, hidden = c(2,1))
```

Plot the resulting network including the weights

```{r}
plot(ess9_ann_net)
```

#### Make Predictions

```{r Predictions, include=FALSE}
test_results <- neuralnet::compute(ess9_ann_net, test_in)
test_results$net.result
```

Find class (i.e. output neuron) with the highest probability and convert this back into a factor

```{r find class, include=FALSE}
test_pred <- apply(test_results$net.result, 1, which.max)
test_pred <- factor(levels(test_truth)[test_pred], levels = levels(test_truth))
test_pred
```

#### Evaluate the Results

```{r conf matrix}
conf_matrix <- confusionMatrix(test_truth, test_pred)
conf_matrix
```

#### Optimize Network Structure

First we need to remodel the data due to some limitations of `caret`

```{r}
xor <- model.matrix(~ netusoft, ess9_ann2)
xor[,1] <- ifelse(xor[,2] %in% 0 & xor[,3] %in% 0, 1, 0)
colnames(xor)[1] <- 'netusoft'
head(xor)
```

```{r}
ess9_ann_mod <- cbind(xor, ess9_ann2 %>% select(-netusoft))
train_mod <- ess9_ann_mod %>% slice(indices)
```

```{r}

set.seed(142)
formula = netusoft + netusoft2 + netusoft3 + netusoft4 + netusoft5 ~ nwspol + stfdem + gndr + agea + yrpy + eduyrs
models <- train(formula, train_mod,
               method="neuralnet",
               linear.output = FALSE,
               ### Parameters for layers
               tuneGrid = expand.grid(.layer1=c(1:2), .layer2=c(0:3), .layer3=c(0)),  
               ### Parameters for optmisation
               learningrate = 0.1,  
               threshold = 0.1,     
               stepmax = 5000         
)

```

And have a look at the different models

```{r}
plot(models)

```

And try out the best model

```{r}
set.seed(42)
best_model <- neuralnet(
  formula,
  ess9_ann_mod %>% slice(indices),
  hidden = c(2,3),
  learningrate = 0.1, 
  threshold = 0.1,   
  stepmax = 20000,
  linear.output = FALSE
)

plot(best_model)

```

## 3.6 Support Vector Machine

### Loading the Packages

We are going to use the `e1071` package for this example and also some helper functions from `caret`

```{r}
library(e1071)
```

```{r}
ess9_de$scale_cat  <- cut(ess9_de$polscale.na,
              breaks=c(-1, 4.5, 7.5, 10),
              labels=c('left', 'center', 'right'))
summary(ess9_de$scale_cat)
summary(as.factor(ess9_de$polscale.na))
ess9_de$scale_cat <- as.factor(ess9_de$scale_cat)
typeof(ess9_de$scale_cat)
summary(ess9_de$scale_cat)
```

```{r}
d.ess9_supportvec <- ess9_de[, c("age.na", "interest.fac", "scale_cat", "eduyrs.na", "sat.dem.fac", "yearpay", "vote.fac")]
d.ess9_supportvec <- d.ess9_supportvec[complete.cases(d.ess9_supportvec),]
str(d.ess9_supportvec)
```

### Have a quick look at the Data

```{r}
d.ess9_supportvec %>%
  ggplot(aes(x = age.na, y = yearpay, color = scale_cat)) +
  geom_point() 

```

```{r}
d.ess9_supportvec %>%
  ggplot(aes(x = age.na, y = eduyrs.na, color = scale_cat)) +
  geom_point()

```

### Prepare the Data for Training

```{r}
set.seed(123)
indices <- createDataPartition(d.ess9_supportvec$scale_cat, p=.85, list = F)
```

### Create some easy Variables to access Data

```{r}
train <- d.ess9_supportvec %>%
  slice(indices)
test_in <- d.ess9_supportvec %>%
  slice(-indices) %>%
  select(-scale_cat)
test_truth <- d.ess9_supportvec %>%
  slice(-indices) %>%
  pull(scale_cat)
```

### Train the Neural Network

```{r}
set.seed(123)
ess_de_svm <- svm(scale_cat ~ ., train, kernel = "linear", scale = TRUE, cost = 10)
summary(ess_de_svm)

```

```{r}
plot(ess_de_svm, train, yearpay ~ age.na)
```

```{r}
#plot(ess_de_svm, train, yearpay ~ age.na, slice = list(yearpay = 150000, age.na = 70))
#muss hier genau gliech viele löschen wie in allen zwei
```

```{r}
set.seed(1)
tune.out <- tune(svm, scale_cat ~ ., data = d.ess9_supportvec, 
                 kernel = "linear", ranges=list(cost=c(0.001,0.01, 0.1, 1, 5, 10, 100)))
tune.summary <- summary(tune.out)
summary(tune.out)
tune.summary
bestmod <- tune.out$best.model
summary(bestmod)
```

### Make Predictions

```{r}
test_pred <- predict(ess_de_svm, test_in)
table(test_pred)
```

### Evaluate the Results

```{r}
conf_matrix <- confusionMatrix(test_pred, test_truth)
conf_matrix
```

### Try again with other parameters

```{r}
set.seed(123)
ess_de_svm.rad <- svm(scale_cat ~ ., train, kernel = "radial", scale = TRUE, cost = 100000)
summary(ess_de_svm.rad)
```

```{r}
plot(ess_de_svm.rad, train, yearpay ~ age.na)
```

```{r}
test_pred1 <- predict(ess_de_svm.rad, test_in)
table(test_pred1)
```

```{r}
conf_matrix <- confusionMatrix(test_pred1, test_truth)
conf_matrix
```
