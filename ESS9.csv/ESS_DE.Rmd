---
title: "European Survey - What is the political sentiment in German speaking Countries Before Covid?"
author: "Milica Pajkic and Marco Rieder"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

# Getting the Data and installing libraries

```{r, include=FALSE}
if (!require("naniar")) install.packages("naniar", dependencies=TRUE)
library(lubridate)
library(multcomp)
library(dplyr)
library(readr)
library(data.table)
library(tidyverse)
library(naniar)
```

```{r}
ess9 <- read_csv("ESS9.csv")
```

```{r making subsets of the whole dataset to only german speaking countries}
ess9_de <- subset(ess9, cntry == "DE", select =dweight:domain)
ess9_ch <- subset(ess9, cntry == "CH", select =dweight:domain)
ess9_at <- subset(ess9, cntry == "AT", select =dweight:domain)
```

# 1. Introduction

# 2. Descriptive Statistics

```{r}
str(ess9_de)
```

```{r }
summary(ess9_de$nwspol)
sum(is.na(ess9_de$nwspol))
```

```{r echo=FALSE}
summary(ess9_de$gndr)
sum(is.na(ess9_de$gndr))
typeof(ess9_de$nwspol)
```

```{r}
ggplot(ess9_de, aes(nwspol, 1)) +
  geom_bar(stat = "identity") + 
  xlim(c(0, 200))
```

### **Was muss man alles fÃ¼r eine deskriptive Analyse machen?**

```{r lineare Regression}
typeof(ess9_de$eduyrs)
summary(ess9_de$eduyrs)
sum(is.na(ess9_de$eduyrs))
```

# MULTIPLIKATION GROSSPAY

```{r Your [pay/pensions/social benefits], which frequency do you know best}
#1 = weekly, 2 = monthly, 3 = annual
typeof(ess9_de$infqbst)
ess9_de$infqbst.na <- ess9_de$infqbst
ess9_de["infqbst.na"][ess9_de["infqbst.na"] >= 4] <- NA
ess9_de$infqbst.fac <- factor(ess9_de$infqbst.na)
typeof(ess9_de$infqbst.fac)
summary(ess9_de$infqbst.fac)
```

```{r gross pay cleaning}
ess9_de$grspnum.na <- ess9_de$grspnum
ess9_de["grspnum.na"][ess9_de["grspnum.na"] >= 666666666] <- NA
summary(ess9_de$grspnum.na)
ess9_de$grspnum.tot <- ess9_de$grspnum.na
```

```{r subset the german dataset}
ess9_income <- subset(ess9_de, select = 1:576)
ess9_income.na <- ess9_income[complete.cases(ess9_income$grspnum.na),]
ess9_income.na <- ess9_income.na[complete.cases(ess9_income.na$infqbst.fac),]
summary(ess9_income.na$infqbst.fac)
```

```{r}
ess9_income.na$yearpay = ifelse(ess9_income.na$infqbst.fac %in% c(1,2), 
                                ess9_income.na$grspnum.na*52, ess9_income.na$grspnum.na*12)
ess9_de$yearpay = ifelse(ess9_de$infqbst.fac %in% c(1,2), 
                                ess9_de$grspnum.na*52, ess9_de$grspnum.na*12)
```

#### Cleaning of the data

##### linear Model

```{r recode Variable resp. clean}
#NEWS Politics time recoded
ess9_de$nwspol.na <- ess9_de$nwspol
ess9_de["nwspol.na"][ess9_de["nwspol.na"] >= 7777] <- NA
#Educationlevel  recoding
ess9_de$eduyrs.na <- ess9_de$eduyrs
ess9_de["eduyrs.na"][ess9_de["eduyrs.na"] >= 77] <- NA
#Added "Other" also under NA bc we cannot explain what other is

#recode the age variable
ess9_de$age.na <- ess9_de$agea
ess9_de["age.na"][ess9_de["age.na"] >= 140] <- NA

#record the gender variable
ess9_de$gender <- ess9_de$gndr
ess9_de["gender"][ess9_de["gender"] >= 9] <- NA
ess9_de$gndr.fac <- factor(ess9_de$gender)

#clean the satisfaction with democracy works in country
ess9_de$stfdem.na <- ess9_de$stfdem
ess9_de["stfdem.na"][ess9_de["stfdem.na"] > 10] <- NA

#clean Boycott certain products
ess9_de$bctprd.na <- ess9_de$bctprd
ess9_de["bctprd.na"][ess9_de["bctprd.na"] > 2] <- NA
ess9_de$boycott.fac <- factor(ess9_de$bctprd.na)

#clean left-right scale 0 =l / 10 = r
ess9_de$polscale.na <- ess9_de$lrscale
ess9_de["polscale.na"][ess9_de["polscale.na"] > 10] <- NA

#clean fair chance to participate in politics in yr country (5er scale)
ess9_de$fairchance <- ess9_de$frprtpl
ess9_de["fairchance"][ess9_de["fairchance"] > 6] <- NA

#clean polinteresse (4er scale)
ess9_de$polinteress <- ess9_de$polintr
ess9_de["polinteress"][ess9_de["polinteress"] > 6] <- NA

#clean confidence in own ability to participate (5er scale)
ess9_de$ability <- ess9_de$cptppola
ess9_de["ability"][ess9_de["ability"] > 6] <- NA

```

```{r polint is factor}
ess9_de$interest.fac <- factor(ess9_de$polinteress, levels=1:4, labels=c("very", "quite", "hardly", "none at all"))
#order differently
ess9_de$interest.fac <- ordered(ess9_de$interest.fac, levels = c("none at all", "hardly", "quite", "very"))
```

```{r confidence in ability as factor}
ess9_de$ability.fac <- factor(ess9_de$ability, levels=1:5, labels=c("not at all", "a little", "quite", "very", "completely"))
summary(ess9_de$ability.fac)
```

```{r satisfaction with how democracy is in the country}
ess9_de$sat.dem.fac <- factor(ess9_de$stfdem.na)
summary(ess9_de$sat.dem.fac)
```

```{r checking}
summary(ess9_de$nwspol)
summary(ess9_de$nwspol.na)
sum(is.na(ess9_de$nwspol.na))

summary(ess9_de$agea)
summary(ess9_de$age.na)

summary(ess9_de$gndr.fac)
sum(is.na(ess9_de$gndr.na))
summary(as.factor(ess9_de$stfdem.na))
sum(is.na(ess9_de$stfdem.na))
sum(is.na(ess9_de$bctprd.na))

sum(is.na(ess9_de$polscale.na))
```

```{r}
boxplot(ess9_de$nwspol.na, outline = FALSE)
```

```{r}
ggplot(ess9_de, aes(eduyrs.na, nwspol.na)) + 
  geom_point() +
  ylim(0, 500)
```

```{r}
ggplot(ess9_de, aes(age.na, nwspol.na)) + 
  geom_point() +
  ylim(0, 500)
```

```{r}
boxplot(ess9_de$nwspol.na, ess9_de$gndr.fac, outline = FALSE)
```

### wieso ist gender = 2 so komisch?

##### Binomial Model

```{r}
summary(ess9_de$vote)
#1 = yes
#2 = no
#elligible
ess9_de$vote_na <- ess9_de$vote
ess9_de["vote_na"][ess9_de["vote_na"] >= 4] <- NA
summary(ess9_de$vote_na)
summary(as.factor(ess9_de$vote.na))
```

```{r}
ess9_de$postonline <- factor(ess9_de$pstplonl)
ess9_de$postonline<-ifelse(ess9_de$postonline==1,1,0)
#ess9_de["pstplonl.na"][ess9_de["pstplonl.na"] > 2] <- NA
summary(ess9_de$postonline)
summary(as.factor(ess9_de$postonline))
ess9_de$postonline <- as.integer(ess9_de$postonline)
typeof(ess9_de$postonline)
```

# 3. Models

## 3.1 Linear Model

Question: What is an influence on the

```{r all variables that i want to include}
#DV
summary(ess9_de$nwspol.na)
#predictorvariables
summary(ess9_de$eduyrs.na)
summary(ess9_de$gndr.fac)
summary(ess9_de$age.na)
summary(ess9_de$stfdem.na)
summary(ess9_de$sat.dem.fac)
summary(ess9_de$ability)
summary(ess9_de$ability.fac)
summary(ess9_de$interest.fac)
summary(as.factor(ess9_de$polinteress))
```

```{r create a DV where no outlier}
ess9_de$nwspol.outlier <- ess9_de$nwspol.na
ess9_de["nwspol.outlier"][ess9_de["nwspol.outlier"] >= 400] <- NA
```

```{r create a subset of data with only the variables mentioned above}
ess9_linear <- ess9_de[, c("nwspol.na", "age.na", "gndr.fac", "eduyrs.na", 
                           "stfdem.na", "ability", "ability.fac", "polinteress", "interest.fac", "sat.dem.fac")]
ess9_linear <- ess9_linear[complete.cases(ess9_linear),]
```

```{r linear Regression}
lm_news.0 <- lm(nwspol.na ~ eduyrs.na, data = ess9_linear)
summary(lm_news.0)
```

```{r}
coef(lm_news.0)
```

```{r}
summary(lm_news.0)$coefficients
```

```{r}
confint(lm_news.0)
```

```{r}
par(mfrow=c(1,2))
plot(nwspol.na ~ eduyrs.na, data = ess9_linear,
     xlim = c(0,31), 
     ylim = c(0, 500))
#the ylim was chosen what makes the most sense over 600min watching news equals to 8h/daily
grid(ny = 20)
##
abline(lm_news.0,
       col = "red", lty = "dashed")
#Zoom in 
plot(nwspol.na ~ eduyrs.na, data = ess9_linear,
     xlim = c(0,31), 
     ylim = c(0, 100))
##
grid()
##
abline(lm_news.0,
       col = "red", lty = "dashed")
```

Interpretation: we can see that the line is nearly flat and the p-value confirms this observation. The p-Value is nearly 1 and the parameter is nearly 0.

```{r outlier will be eliminated (above 400min)}
lm.news.outlier <- lm(nwspol.outlier ~ eduyrs.na, data = ess9_de, na.omit = TRUE)
summary(lm.news.outlier)
```

#### adding additional predictors

```{r}
lm_news.1 <- lm(nwspol.na ~ eduyrs.na + age.na, data = ess9_linear)
summary(lm_news.1)
```

```{r}
coef(lm_news.1)
```

```{r}
summary(lm_news.1)$coefficients
```

```{r}
confint(lm_news.1)
```

**We can see that the predictor age has a low p-value and it is signifcant.**

```{r}
lm_news.2 <- lm(nwspol.na ~ eduyrs.na + age.na + gndr.fac + stfdem.na + ability.fac + interest.fac, data = ess9_linear)
summary(lm_news.2)
```

```{r}
coef(lm_news.2)
```

```{r}
summary(lm_news.2)$coefficients
```

```{r}
confint(lm_news.2)
```

```{r}
cis.lm_news.2 <- confint(lm_news.2)
##
## 2) plot estimates
par(mar = c(4,5,2,2))
plot(y = 1:7,
     x = rev(coef(lm_news.2)),
     xlim = c(-20, 120),
     xlab = "Estimated coefficients",
     ylab = "",
     axes = FALSE)
box()
axis(side = 2, at = 1:7,
     labels = rev(names(coef(lm_news.2))), 
     las = 2)
axis(side = 1)

segments(x0 = rev(cis.lm_news.2[, "2.5 %"]),
         x1 = rev(cis.lm_news.2[, "97.5 %"]),
         y0 = 1:7,
         y1 = 1:7)
abline(v = 0, lty = "dashed")
```

#### Interaction: Age \* Interest

```{r}
lm_news.3 <- lm(nwspol.na ~ eduyrs.na + age.na * interest.fac + gndr.fac + stfdem.na + ability, data = ess9_linear)
summary(lm_news.3)
```

```{r}
coef(lm_news.3)
```

```{r}
summary(lm_news.3)$coefficients
```

```{r}
confint(lm_news.3)
```

```{r}
cis.lm_news.3 <- confint(lm_news.3)
##
## 2) plot estimates
par(mar = c(4,8,2,2))
plot(y = 1:8,
     x = rev(coef(lm_news.3)),
     xlim = c(-20, 100),
     xlab = "Estimated coefficients",
     ylab = "",
     axes = FALSE)
box()
axis(side = 2, at = 1:8,
     labels = rev(names(coef(lm_news.3))), 
     las = 2)
axis(side = 1)

segments(x0 = rev(cis.lm_news.3[, "2.5 %"]),
         x1 = rev(cis.lm_news.3[, "97.5 %"]),
         y0 = 1:8,
         y1 = 1:8)
abline(v = 0, lty = "dashed")
```

A finding is: the interaction with age and polinterest is there

#### Fitted Values

```{r fitted values}
fit_lm_news.0 <- fitted(lm_news.0)
str(fit_lm_news.0)
head(fit_lm_news.0)
```

```{r fitted values plot lm1}
plot(nwspol.na ~ eduyrs.na, data = ess9_linear, 
     main = "Minutes spent on Political News", 
     col = "darkgrey",
     ylim = c(0, 500))
points(fit_lm_news.0 ~ eduyrs.na, 
       col = "purple", 
       pch = 19, 
       data = ess9_linear)
abline(lm_news.0, col = "black")
```

```{r}
lm_news.2 <- lm(nwspol.na ~ eduyrs.na + age.na, data = ess9_de)
summary(lm_news.2)
```

```{r}
coef(lm_news.2)
```

```{r}
summary(lm_news.2)$coefficients
```

```{r}
plot(nwspol.na ~ eduyrs.na + age.na, data = ess9_de, main = "Minutes spent on Political News")
abline(lm_news.2)
```

```{r}
lm_news.3 <- lm(nwspol.na ~ eduyrs.na + age.na + gndr.fac, data = ess9_de)
summary(lm_news.3)
```

## 3.2 GLM Poisson

```{r}
glmP_news <- glm(nwspol ~ edu,
family = "poisson", ## we specify the distribution!
data = ess9_ch)
```

## 3.3 GLM Binominal

### maybe change the "direction" of yes/no to higher number = yes

```{r clean data}
#y = posted online
summary(as.factor(ess9_de$postonline))
#x1 = age
summary(ess9_de$age.na)
#x2 = interest in politics (1 till 2 = yes)
ess9_de$polint <- ess9_de$polintr
ess9_de["polint"][ess9_de["polint"] > 4] <- NA
summary(as.factor(ess9_de$polint))
#x3 pol system allows (1 till 3 = no)
ess9_de$gov.allows <- ess9_de$psppsgva
ess9_de["gov.allows"][ess9_de["gov.allows"] > 5] <- NA
summary(as.factor(ess9_de$gov.allows))
#trust in parliament (0-5 = no at all)
ess9_de$trustparl <- ess9_de$trstprl
ess9_de["trustparl"][ess9_de["trustparl"] > 10] <- NA
summary(as.factor(ess9_de$trustparl))
#political scale (0-5 = left)
summary(as.factor(ess9_de$polscale.na))
```

```{r subset of dataframe because of differen NA}
ess9_binary <- ess9_de[, c("postonline", "age.na", "polint", "gov.allows", "trustparl", "polscale.na")]
ess9_binary.na <- ess9_binary[complete.cases(ess9_binary),]
```

```{r EDA}
ggplot(data = ess9_binary.na,
       mapping = aes(y = postonline,
                     x = age.na))+
  geom_point()
```

```{r glm model for binary data}
glm_pol.0 <- glm(postonline ~ age.na, data = ess9_binary.na,
                 family = "binomial")
summary(glm_pol.0)
```

```{r}
fitted(glm_pol.0) %>% round(digits = 2)
```

```{r}
fitted_glm.pol.0.disc <- ifelse(fitted(glm_pol.0) < 0.5, 
                                yes = 0, no = 1)
head(fitted_glm.pol.0.disc)
```

`{d.obs.fit.glm.pol <- data.frame(obs = ess9_binary.na$postonline,}                                   fitted = fitted_glm.pol.0.disc) table(d.obs.fit.glm.pol)`

```{r binary regression with more than 1 predictor}
glm_pol.1 <- glm(postonline ~ age.na + polint, data = ess9_binary.na,
                 family = "binomial")
summary(glm_pol.1)
```

```{r}
glm_pol.2 <- glm(postonline ~ age.na + polint + polscale.na, data = ess9_binary.na,
                 family = "binomial")
summary(glm_pol.2)
```

```{r}
glm_pol.1 <- glm(postonline ~ age.na + polint + polscale.na + trustparl, data = ess9_binary.na,
                 family = "binomial")
summary(glm_pol.1)
```

## 3.4 GAM

## 3.5 Neural Network

## 3.6 Support Vector Machine

### Loading the Packages

First make sure we have all the functionality from the `tidyverse` available:

```{r}
library(tidyverse)
theme_set(theme_bw())
```

We are going to use the `e1071` package for this example and also some helper functions from `caret`

```{r}
library(e1071) 
library(caret)
```

```{r}
ess9_de$scale_cat  <- cut(ess9_de$polscale.na,
              breaks=c(-1, 2.5, 4.5, 5.5, 7.5, 10),
              labels=c('left', 'center left', 'center', 'center right', 'right'))
summary(ess9_de$scale_cat)
summary(as.factor(ess9_de$polscale.na))
ess9_de$scale_cat <- as.factor(ess9_de$scale_cat)
typeof(ess9_de$scale_cat)
summary(ess9_de$scale_cat)
```

```{r}
d.ess9_supportvec <- ess9_de[, c("postonline", "age.na", "polint", "gov.allows", 
                                 "trustparl", "polscale.na", "scale_cat", "nwspol.na")]
d.ess9_supportvec <- d.ess9_supportvec[complete.cases(d.ess9_supportvec),]
```

## Have a quick look at the Data

```{r}
d.ess9_supportvec %>%
  ggplot(aes(x = age.na, y = nwspol.na, color = scale_cat)) +
  geom_point() +
  ylim(0, 250)
```

```{r}
d.ess9_supportvec %>%
  ggplot(aes(x = age.na, y = trustparl, color = scale_cat)) +
  geom_point()
```

## Prepare the Data for Training

```{r}
set.seed(123)
indices <- createDataPartition(d.ess9_supportvec$scale_cat, p=.85, list = F)
```

### Create some easy Variables to access Data

```{r}
train <- d.ess9_supportvec %>%
  slice(indices)
test_in <- d.ess9_supportvec %>%
  slice(-indices) %>%
  select(-scale_cat)
test_truth <- d.ess9_supportvec %>%
  slice(-indices) %>%
  pull(scale_cat)
```

## Train the Neural Network

Call the `svm` function using the default `cost = 10` parameter.

```{r}
set.seed(123)
ess_de_svm <- svm(scale_cat ~ ., train, kernel = "linear", scale = TRUE, cost = 10)
```

Of course the visualization is a bit difficult as we have some classification regions in four dimensions.

So plot first the resulting classification for the two Petal leaf dimensions

```{r}
plot(ess_de_svm, train, age.na ~ nwspol.na)
```

And for the Sepal leaf dimensions (of course you need to slice the other dimensions at a reasonable point)

```{r}
plot(iris_svm, train, Sepal.Length ~ Sepal.Width, slice = list(Petal.Length = 4.5, Petal.Width = 1.75))
```

## Make Predictions

```{r}
test_pred <- predict(ess_de_svm, test_in)
table(test_pred)
```

## Evaluate the Results

```{r}
conf_matrix <- confusionMatrix(test_pred, test_truth)
conf_matrix
```

So we have a resulting SVM with a prediction accuracy of around 95% (of course we would also need to do some cross validation to ensure we were not simply "lucky" with the train/test split).

## Try again with other parameters

```{r}
set.seed(123)
iris_svm2 <- svm(Species ~ ., train, kernel = "radial", scale = TRUE, cost = 100)
summary(iris_svm2)
```

```{r}
plot(iris_svm2, train, Petal.Length ~ Petal.Width, slice = list(Sepal.Length = 6, Sepal.Width = 3))
```

```{r}
plot(iris_svm2, train, Sepal.Length ~ Sepal.Width, slice = list(Petal.Length = 4.5, Petal.Width = 1.75))
```

```{r}
test_pred <- predict(iris_svm2, test_in)
table(test_pred)
```

```{r}
conf_matrix <- confusionMatrix(test_pred, test_truth)
conf_matrix
```

So we have here the same accuracy but with much more complex boundaries (radial kernels and higher costs) so we might be overfitting here a bit more.
